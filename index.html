<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MeteoRide</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='sky' x1='0%25' y1='0%25' x2='0%25' y2='100%25'><stop offset='0%25' stop-color='%2387CEEB'/><stop offset='100%25' stop-color='%23E0F6FF'/></linearGradient><linearGradient id='bike' x1='0%25' y1='0%25' x2='100%25' y2='0%25'><stop offset='0%25' stop-color='%232563eb'/><stop offset='100%25' stop-color='%231d4ed8'/></linearGradient></defs><rect width='100' height='100' fill='url(%23sky)' rx='20'/><circle cx='25' cy='70' r='12' fill='%23374151' stroke='%23111827' stroke-width='2'/><circle cx='75' cy='70' r='12' fill='%23374151' stroke='%23111827' stroke-width='2'/><path d='M25 70 L40 50 L60 50 L75 70' fill='none' stroke='url(%23bike)' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/><path d='M40 50 L45 35 L55 35' fill='none' stroke='url(%23bike)' stroke-width='3' stroke-linecap='round'/><path d='M50 35 L50 45' fill='none' stroke='url(%23bike)' stroke-width='2' stroke-linecap='round'/><circle cx='30' cy='25' r='8' fill='%23FCD34D' stroke='%23F59E0B' stroke-width='1.5'/><path d='M22 25 L30 25 L38 25 M30 17 L30 25 L30 33' stroke='%23F59E0B' stroke-width='1.5' stroke-linecap='round'/><path d='M65 30 C68 30 70 32 70 35 C70 38 68 40 65 40 C62 40 60 38 60 35 C60 32 62 30 65 30' fill='%23E5E7EB' stroke='%23D1D5DB' stroke-width='1'/><path d='M80 20 C83 20 85 22 85 25 C85 28 83 30 80 30 C77 30 75 28 75 25 C75 22 77 20 80 20' fill='%23F3F4F6' stroke='%23D1D5DB' stroke-width='1'/></svg>"/>
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons-wind.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-compass@1.5.6/dist/leaflet-compass.min.css" />

<!-- iOS PWA meta -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" /> <!-- NEW: recommended meta to silence deprecation warning -->
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<!-- Minor visual fixes: align header buttons and normalize speed input/presets styling -->
<style>
    /* Header/nav buttons: align icon + text vertically */
    header nav button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: transparent;
      border: none;
      cursor: pointer;
      font: inherit;
      color: inherit;
    }
    /* Ensure the emoji/icon inside debug button is baseline-aligned and not taller */
    #toggleDebug .debug-ico,
    #toggleConfig .config-ico,
    #toggleHelp .help-text {
      display: inline-block;
      line-height: 1;
      vertical-align: middle;
      transform: translateY(0);
      font-size: 1em;
    }
    #toggleDebug .debug-text,
    #toggleConfig .config-text {
      display: inline-block;
      vertical-align: middle;
      line-height: 1;
    }

    /* Speed input and presets: match the select style (soft grey bg, rounded border, consistent height) */
    .speed-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .speed-wrap input[type="number"],
    .speed-wrap .speed-presets {
      background: var(--input-bg, #f3f4f6);
      border: 1px solid var(--input-border, #cbd5e1);
      border-radius: 6px;
      padding: 6px 8px;
      height: 36px;
      box-sizing: border-box;
      color: inherit;
      font: inherit;
      -webkit-appearance: none;
      appearance: none;
    }
    /* Reduce number field spinner visual noise on WebKit while keeping functionality */
    .speed-wrap input[type="number"]::-webkit-outer-spin-button,
    .speed-wrap input[type="number"]::-webkit-inner-spin-button {
      margin: 0;
      opacity: 0.6;
      -webkit-appearance: none;
    }

    /* Ensure small-file-btn / file label aligns with the controls */
    .file-btn.small-file-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 8px;
      border-radius: 6px;
      border: 1px solid var(--input-border, #cbd5e1);
      background: var(--input-bg, #f3f4f6);
      cursor: pointer;
    }

    /* On very small screens, slightly reduce paddings to avoid wrapping */
    @media (max-width: 520px) {
      header nav button { padding: 6px 8px; gap: 4px; }
      .speed-wrap input[type="number"],
      .speed-wrap .speed-presets,
      .file-btn.small-file-btn {
        height: 34px;
        padding: 5px 7px;
        border-radius: 6px;
      }
      /* Ensure debug emoji doesn't push the line height on iOS */
      #toggleDebug .debug-ico { font-size: 0.98em; }
    }
  </style>
</head>
<body>
<header>
<!-- traducible: t√≠tulo de la app -->
<h1 data-i18n="title">üö¥ MeteoRide</h1>
<nav>
<button id="toggleConfig" title="Configuraci√≥n">
  <span class="config-text" data-i18n="toggle_config">Configuraci√≥n</span>
  <span class="config-ico" aria-hidden="true">‚öôÔ∏è</span>
</button>
<button id="toggleHelp" data-i18n="toggle_help" title="Ayuda">
  <span class="help-text">Ayuda</span> ‚ùì
</button>
<!-- CHANGED: icono + texto para igualar ocupaci√≥n/altura como los otros -->
<button id="toggleDebug" data-i18n="toggle_debug" title="Debug">
  <span class="debug-ico" aria-hidden="true">üêû</span>
  <span class="debug-text" data-i18n="toggle_debug_label">Debug</span>
</button>
</nav>
</header>

<aside id="configMenu" style="display: none;">
  <div class="config-panel">
    <div class="config-row">
    </div>

    <!-- NEW: Notice verbosity option -->
    <div class="config-row">
      <label class="inline">
        <input type="checkbox" id="noticeAll" checked />
        <span data-i18n="notices_noncritical_label">Mostrar avisos no cr√≠ticos</span>
      </label>
    </div>

    <h4 style="font-size: 14px; margin: 8px 0; text-decoration: underline; color: #203050;" data-i18n="api_key_init">API Key</h4>
    <div class="config-row">
      <label for="apiKey" data-i18n="api_key_label">MeteoBlue:</label>
      <input type="text" id="apiKey" data-i18n-placeholder="api_key_placeholder" placeholder="Introduce la API Key MeteoBlue" />
      <button type="button" id="checkApiKey" data-i18n="check_key">Check</button>
    </div>
    <div id="apiKeyStatus" class="key-status" aria-live="polite"></div>

    <div class="config-row">
      <label for="apiKeyOW" data-i18n="api_key_label_ow">OpenWeather:</label>
      <input type="text" id="apiKeyOW" data-i18n-placeholder="api_key_placeholder" placeholder="Introduce la API Key OpenWeather" />
      <button type="button" id="checkApiKeyOW" data-i18n="check_key">Check</button>
    </div>
    <div id="apiKeyStatusOW" class="key-status" aria-live="polite"></div>

    <h4 style="font-size: 14px; margin: 8px 0; text-decoration: underline; color: #203050;" data-i18n="units_label">Localizaci√≥n</h4>
    <div class="config-row">
      <label for="language" data-i18n="language_label">Idioma:</label>
      <select id="language">
        <option value="es" selected>Espa√±ol</option>
        <option value="en">English</option>
      </select>
    </div>
    <div class="config-row">
      <div class="unit-pair">
        <label for="windUnits" data-i18n="wind_units_label">Unidades viento:</label>
        <select id="windUnits">
          <option value="kmh" selected>Km/h</option>
          <option value="ms">m/s</option>
          <option value="mph">Mph</option>
        </select>
      </div>
      <div class="unit-pair">
        <label for="tempUnits" data-i18n="temp_units_label">Unidades temperatura:</label>
        <select id="tempUnits">
          <option value="C" selected>¬∞C</option>
          <option value="F">¬∞F</option>
        </select>
      </div>
    </div>
   

    <div class="config-row">
      <div class="unit-pair">
        <label for="distanceUnits" data-i18n="distance_units_label">Unidades distancia:</label>
        <select id="distanceUnits">
          <option value="km" selected>Km</option>
          <option value="mi">Mi</option>
        </select>
      </div>
      <div class="unit-pair">
        <label for="precipUnits" data-i18n="precip_units_label">Unidades precipitaci√≥n:</label>
        <select id="precipUnits">
          <option value="mm" selected>Mm</option>
          <option value="in">In</option>
        </select>
      </div>
    </div>
  </div>
</aside>

<section id="debugSection" hidden>
  <div id="debugConsole" style="background:#222;color:#eee;font-family: monospace; font-size:12px; max-height:150px; overflow:auto; padding:10px;"></div>
</section>

<main>
  <div id="map" style="height:60vh;"></div>
  <div id="controlsPanel">
    <div class="params">
      <label for="datetimeRoute" data-i18n="route_datetime_label">Fecha y hora ruta:</label>
      <input type="datetime-local" id="datetimeRoute" step="900"/>

      <label for="cyclingSpeed" data-i18n="cycling_speed_label">Velocidad media (km/h):</label>
      <div class="speed-wrap">
        <input type="number" id="cyclingSpeed" value="20" min="5" max="60" />
        <select id="speedPresets" class="speed-presets" aria-label="Presets speed">
          <option value="" selected>‚Äî</option>
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="12">12</option>
          <option value="15">15</option>
          <option value="20">20</option>
        </select>
      </div>

      <label for="intervalSelect" data-i18n="interval_label">Intervalo (minutos):</label>
      <select id="intervalSelect">
        <option value="15" selected>15</option>
        <option value="30">30</option>
      </select>

      <!-- Provider selector moved here (to the right of Interval) -->
      <label for="apiSource" data-i18n="provider_label">Proveedor:</label>
      <select id="apiSource">
        <option value="meteoblue" selected>MeteoBlue</option>
        <option value="openmeteo">OpenMeteo</option>
        <option value="openweather">OpenWeather</option>
        <option value="ow2_arome_openmeteo">OPW ‚Üí AromeHD</option>
        <option value="aromehd">Arome‚ÄëHD</option>
        <!-- add compare option (no removals) -->
        <option value="compare">Comp.</option>
      </select>

      <!-- archivo GPX justo a continuaci√≥n del selector de intervalo -->
      <label class="file-btn small-file-btn" for="gpxFile" title="Upload file">üìÅ</label>
      <input type="file" id="gpxFile" accept=".gpx" />
    </div>

    <!-- Nombre de la ruta: nueva l√≠nea, justo debajo de los selectores y antes de la tabla -->
    <div id="rutaName" class="ruta-name" aria-live="polite"></div>

    <!-- NEW: forecast horizon/fallback notice -->
    <div id="horizonNotice" class="notice" hidden aria-live="polite"></div>

    <!-- CHANGED: add wrapper so overlays don't scroll -->
    <div class="wtc-wrap">
      <div id="weatherTableContainer">
        <table id="weatherTable"></table>
      </div>
    </div>
  </div>
</main>
<div id="loadingOverlay" data-i18n="loading_text" style=" position: fixed; z-index: 20000; inset: 0; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; pointer-events: none; font-size: 1.5rem; color: #1e40af; font-weight: 700; user-select: none; ">
    Loading...
</div>

<!-- NEW: live viewport badge -->
<div id="vpBadge" aria-hidden="true"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-compass@1.5.6/dist/leaflet-compass.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="utils.js"></script>
<script src="ui.js"></script>
<script src="app.js"></script>
<script src="gpx-ingest.js"></script>
<script src="compare.js"></script>
<script src="ui_weather.js"></script>
<script src="console_debug.js"></script>
<script>
  // --- BEGIN: client-only GPX handoff (trimmed) ---
  // Keep only SW registration, unified loader facade and IDB/sessionStorage handoff.
  (function(){
    // Register service worker so Shortcuts can POST the GPX and SW can persist it to IndexedDB.
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch((err) => {
        console.warn('[cw] sw register failed', err);
      });
      // Optional fast path: when SW notifies a client that a GPX arrived, try to read it immediately.
      navigator.serviceWorker.addEventListener && navigator.serviceWorker.addEventListener('message', (ev) => {
        try {
          if (ev.data && ev.data.type === 'cw-shared-gpx') {
            readSharedGPXFromIDB().then(payload => {
              if (payload && payload.text) {
                window.cwInjectGPXFromText(payload.text, payload.name || ev.data.name);
              }
            }).catch(()=>{});
          }
        } catch(_) {}
      });
    }

    // Facade: prefer cwLoadGPXFromString when available, otherwise postMessage fallback.
    window.cwInjectGPXFromText = function(gpxText, routeName){
      try {
        const name = routeName || 'Shared route';
        if (typeof window.cwLoadGPXFromString === 'function') {
          window.cwLoadGPXFromString(String(gpxText || ''), name);
          return true;
        }
        window.postMessage({ type: 'cw-gpx', name, gpx: String(gpxText || '') }, '*');
        return true;
      } catch(e){
        console.error('[cw] cwInjectGPXFromText error', e);
        return false;
      }
    };

    // sessionStorage handoff (keeps existing behavior for open-in from other pages)
    try {
      const KEY = 'cw_gpx_text';
      const KEY_NAME = 'cw_gpx_name';
      const ss = window.sessionStorage;
      const pending = ss ? ss.getItem(KEY) : null;
      if (pending) {
        const routeName = ss.getItem(KEY_NAME) || 'Shared route';
        ss.removeItem(KEY);
        ss.removeItem(KEY_NAME);
        window.cwInjectGPXFromText(pending, routeName);
        console.log('[cw] loaded GPX from sessionStorage');
        if (window.openDebug) window.openDebug();
      }
    } catch(e){ console.warn('[cw] sessionStorage unavailable', e); }

    // Read GPX stored by the Service Worker in IndexedDB (one-time read)
    async function readSharedGPXFromIDB() {
      if (typeof indexedDB === 'undefined') return null;
      return new Promise((resolve) => {
        const req = indexedDB.open('cw_shared_db', 1);
        req.onupgradeneeded = (evt) => {
          try { evt.target.result.createObjectStore('files'); } catch(_) {}
        };
        req.onsuccess = (evt) => {
          try {
            const db = evt.target.result;
            const tx = db.transaction('files', 'readwrite');
            const store = tx.objectStore('files');
            const gt = store.get('gpx');
            gt.onsuccess = () => {
              const val = gt.result || null;
              if (val) {
                // remove stored item so it's one-time
                store.delete('gpx');
              }
              tx.oncomplete = () => { try { db.close(); } catch(_) {} ; resolve(val); };
            };
            gt.onerror = () => { try { db.close(); } catch(_) {} ; resolve(null); };
          } catch (err) { resolve(null); }
        };
        req.onerror = () => resolve(null);
      });
    }

    // On load try to read any GPX the SW might have stored
    (async () => {
      try {
        const payload = await readSharedGPXFromIDB();
        if (payload && payload.text) {
          console.log('[cw] loaded GPX from IndexedDB (service-worker handoff)', payload.name || '');
          if (typeof window.cwInjectGPXFromText === 'function') {
            window.cwInjectGPXFromText(payload.text, payload.name || 'Shared route');
          } else {
            window.postMessage({ type: 'cw-gpx', name: payload.name || 'Shared route', gpx: payload.text }, '*');
          }
        }
      } catch (e) { console.warn('[cw] readSharedGPXFromIDB error', e); }
    })();
  })();
  // --- END: client-only GPX handoff (trimmed) ---
</script>
</body>
</html>